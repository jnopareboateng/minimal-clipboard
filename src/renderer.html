<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clipboard History</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(10px);
      color: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
      padding: 12px 16px;
      background: rgba(40, 40, 40, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: drag;
      -webkit-user-select: none;
      user-select: none;
      position: relative;
      z-index: 0;
    }

    .actions {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      gap: 8px;
      align-items: center;
      -webkit-app-region: no-drag;
      width: 100%;
    }

    .title {
      font-size: 12px;
      font-weight: 500;
      color: #aaaaaa;
      flex-shrink: 0;
    }

    .hotkey {
      font-size: 11px;
      color: #666666;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      -webkit-app-region: no-drag;
    }

    .clear-btn {
      background: none;
      border: none;
      color: #666666;
      cursor: pointer;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
      -webkit-app-region: no-drag;
    }

    .clear-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #aaaaaa;
    }

    .icon-btn {
      background: none;
      border: none;
      color: #cccccc;
      cursor: pointer;
      width: 26px;
      height: 26px;
      display: grid;
      place-items: center;
      border-radius: 4px;
      -webkit-app-region: no-drag;
      transition: all 0.2s;
      font-size: 16px;
      line-height: 1;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }

    .clipboard-list {
      max-height: 450px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
      -webkit-app-region: no-drag;
      position: relative;
      z-index: 0;
      /* Smooth scrolling optimizations */
      scroll-behavior: smooth;
      will-change: scroll-position;
      /* GPU acceleration for better scrolling */
      transform: translateZ(0);
      backface-visibility: hidden;
      /* Prevent layout shifts during scrolling */
      contain: layout style paint;
      /* Additional scroll optimizations */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      /* Better momentum on macOS */
      -webkit-momentum-scrolling: auto;
    }

    /* Virtual scrolling container */
    .virtual-list {
      position: relative;
      min-height: 100%;
    }

    /* Spacer for virtual scrolling */
    .virtual-spacer {
      height: 0;
      pointer-events: none;
    }

    .clipboard-list::-webkit-scrollbar {
      width: 8px;
    }

    .clipboard-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .clipboard-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    .clipboard-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Firefox smooth scrolling fallback */
    @supports (-moz-appearance: none) {
      .clipboard-list {
        scroll-behavior: smooth;
        -moz-scroll-behavior: smooth;
      }
    }

    .clipboard-item {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: background-color 0.15s ease, transform 0.15s ease;
      position: relative;
      -webkit-app-region: no-drag;
      /* Performance optimizations */
      will-change: transform, background-color;
      contain: layout style paint;
      /* Prevent layout shifts */
      min-height: 60px;
      box-sizing: border-box;
    }

    .clipboard-thumb {
      display: block;
      max-width: 100%;
      max-height: 140px;
      border-radius: 6px;
      margin-bottom: 8px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset;
    }

    .clipboard-item:hover {
      background: rgba(255, 255, 255, 0.08);
      /* Use transform for better performance */
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .clipboard-item:active {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(0) scale(0.99);
      transition: transform 0.1s ease, background-color 0.1s ease;
    }

    .clipboard-text {
      font-size: 13px;
      line-height: 1.4;
      color: #ffffff;
      word-break: break-word;
      line-clamp: 3;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .clipboard-time {
      font-size: 10px;
      color: #666666;
      margin-top: 4px;
    }

    .empty-state {
      padding: 40px 16px;
      text-align: center;
      color: #666666;
    }

    .empty-icon {
      font-size: 24px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .empty-text {
      font-size: 12px;
    }

    /* While modal is open, disable interactions below and ensure no drag region interferes */
    body.modal-open .header,
    body.modal-open .clipboard-list {
      pointer-events: none;
      -webkit-app-region: no-drag;
    }

    /* Remove backdrop filter when modal is open to prevent stacking context issues */
    body.modal-open {
      backdrop-filter: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="actions">
      <input type="text" id="search" placeholder="Search..." style="height:22px;padding:0 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2);color:#ddd;min-width:140px;">
      <span class="hotkey" id="hotkey-display">Ctrl+Shift+V</span>
      <button class="icon-btn" onclick="openSettings()" title="Settings" aria-label="Settings">‚öô</button>
      <button class="clear-btn" onclick="clearHistory()" title="Clear history" aria-label="Clear history">üóëÔ∏è</button>
    </div>
  </div>

  <div class="clipboard-list" id="clipboard-list">
    <div class="empty-state">
      <div class="empty-icon">üìã</div>
      <div class="empty-text">Your clipboard history will appear here</div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" style="position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,0.5);-webkit-app-region:no-drag;overflow:auto;z-index:999999;">
    <div style="width:340px;background:#222;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:16px;color:#ddd;margin:40px 0;position:relative;z-index:1000000;">
      <div style="font-size:13px;margin-bottom:8px;color:#aaa;">Settings</div>
      <label style="display:block;font-size:12px;margin:8px 0 4px;">Max history</label>
      <input id="set-max-history" type="number" min="5" max="200" step="1" style="width:100%;height:28px;padding:0 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#ddd;">
      <label style="display:block;font-size:12px;margin:8px 0 4px;">Thumbnail width (px)</label>
      <input id="set-thumb-width" type="number" min="60" max="600" step="10" style="width:100%;height:28px;padding:0 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#ddd;">
      <label style="display:block;font-size:12px;margin:8px 0 4px;">Single-click action</label>
      <select id="set-single-click" style="width:100%;height:28px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#ddd;">
        <option value="copy">Copy</option>
        <option value="paste">Paste</option>
        <option value="none">None</option>
      </select>
      <label style="display:block;font-size:12px;margin:8px 0 4px;">
        <input id="set-remember-pos" type="checkbox"> Remember window position
      </label>
      <label style="display:block;font-size:12px;margin:8px 0 4px;">Hotkey</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="set-hotkey" type="text" readonly placeholder="Click to set hotkey" style="flex:1;height:28px;padding:0 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#ddd;cursor:pointer;">
        <button id="reset-hotkey" type="button" style="height:28px;padding:0 12px;border-radius:4px;border:1px solid rgba(255,255,255,0.1);background:#333;color:#ddd;cursor:pointer;font-size:11px;">Reset</button>
      </div>
      <div id="hotkey-help" style="font-size:10px;color:#666;margin-top:2px;">Default: <span id="default-hotkey">Ctrl+Shift+V</span></div>
       
       <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
         <div style="font-size:11px;color:#888;margin-bottom:4px;">Data Storage Location:</div>
         <div id="data-location" style="font-size:10px;color:#666;word-break:break-all;background:#111;padding:4px 6px;border-radius:3px;font-family:monospace;">Loading...</div>
       </div>
       
       <button class="clear-btn" onclick="clearHistory(); closeSettings();" style="margin-top:12px;color:#ff6b6b;">Clear history</button>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;position:sticky;bottom:0;background:#222;padding-top:8px;">
        <button class="clear-btn" onclick="closeSettings()">Cancel</button>
        <button class="clear-btn" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    let settings = null;
    let allItems = [];

    // Format time ago
    function timeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return Math.floor(diff / 86400000) + 'd ago';
    }

    // Virtual scrolling configuration
    const ITEM_HEIGHT = 70; // Approximate height of each clipboard item
    const BUFFER_SIZE = 5; // Number of items to render outside visible area
    let virtualScrollState = {
      allItems: [],
      visibleItems: [],
      scrollTop: 0,
      containerHeight: 450,
      startIndex: 0,
      endIndex: 0,
      totalHeight: 0
    };
    let itemsChanged = false; // Flag to track when items have changed

    // Render clipboard items with virtual scrolling for optimal performance
    function renderClipboard(items) {
      const list = document.getElementById('clipboard-list');

      if (!items || items.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div class="empty-text">Your clipboard history will appear here</div>
          </div>
        `;
        virtualScrollState.allItems = [];
        itemsChanged = true;
        return;
      }

      // Check if items actually changed to avoid unnecessary updates
      const itemsChangedCheck = !virtualScrollState.allItems ||
        virtualScrollState.allItems.length !== items.length ||
        virtualScrollState.allItems.some((item, index) =>
          !items[index] || item.id !== items[index].id || item.timestamp !== items[index].timestamp
        );

      if (itemsChangedCheck) {
        virtualScrollState.allItems = items;
        virtualScrollState.totalHeight = items.length * ITEM_HEIGHT;
        itemsChanged = true;

        // Initialize virtual scrolling container if not exists
        if (!list.querySelector('.virtual-list')) {
          list.innerHTML = `
            <div class="virtual-list">
              <div class="virtual-spacer"></div>
              <div class="virtual-items"></div>
            </div>
          `;
          setupVirtualScroll();
        }

        // Update visible items only if items changed
        updateVisibleItems();
      }
    }

    function setupVirtualScroll() {
      const list = document.getElementById('clipboard-list');
      const virtualList = list.querySelector('.virtual-list');
      const spacer = list.querySelector('.virtual-spacer');

      // Set spacer height to represent total content
      spacer.style.height = virtualScrollState.totalHeight + 'px';

      // Handle scroll events
      list.addEventListener('scroll', (e) => {
        virtualScrollState.scrollTop = e.target.scrollTop;
        updateVisibleItems();
      }, { passive: true });

      // Initial setup
      virtualScrollState.containerHeight = list.clientHeight;
      updateVisibleItems();
    }

    function updateVisibleItems() {
      const { allItems, scrollTop, containerHeight } = virtualScrollState;
      if (!allItems.length) return;

      // Calculate visible range with buffer
      const startIndex = Math.max(0, Math.floor(scrollTop / ITEM_HEIGHT) - BUFFER_SIZE);
      const visibleCount = Math.ceil(containerHeight / ITEM_HEIGHT) + (BUFFER_SIZE * 2);
      const endIndex = Math.min(allItems.length, startIndex + visibleCount);

      // Only update if range has changed significantly or items have changed
      if (startIndex === virtualScrollState.startIndex && endIndex === virtualScrollState.endIndex && !itemsChanged) {
        return;
      }

      virtualScrollState.startIndex = startIndex;
      virtualScrollState.endIndex = endIndex;

      const virtualItems = document.querySelector('.virtual-items');
      const existingItems = virtualItems.children;
      const fragment = document.createDocumentFragment();

      // Calculate offset for positioning
      const offsetY = startIndex * ITEM_HEIGHT;

      // Incremental update: only recreate items that changed
      const currentVisibleItems = [];

      for (let i = startIndex; i < endIndex; i++) {
        const item = allItems[i];
        currentVisibleItems.push(item);

        const itemDiv = createItemElement(item, i);
        itemDiv.style.position = 'absolute';
        itemDiv.style.top = ((i - startIndex) * ITEM_HEIGHT + offsetY) + 'px';
        itemDiv.style.width = '100%';
        itemDiv.style.transform = 'translateZ(0)'; // Force GPU acceleration
        fragment.appendChild(itemDiv);
      }

      // Use requestAnimationFrame for smooth updates
      requestAnimationFrame(() => {
        // Clear and update visible items
        virtualItems.innerHTML = '';
        virtualItems.appendChild(fragment);

        // Update spacer height
        const spacer = document.querySelector('.virtual-spacer');
        if (spacer) {
          spacer.style.height = (allItems.length * ITEM_HEIGHT) + 'px';
        }

        // Reset change flag
        itemsChanged = false;
      });
    }

    function createItemElement(item, index) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'clipboard-item';
      itemDiv.style.willChange = 'auto';
      itemDiv.setAttribute('data-index', index);

      if (item.type === 'image') {
        const dims = item.width && item.height ? `${item.width}√ó${item.height}` : '';
        itemDiv.setAttribute('data-type', 'image');
        itemDiv.setAttribute('data-id', item.id);

        // Create placeholder image for lazy loading
        const img = document.createElement('img');
        img.className = 'clipboard-thumb';
        img.alt = 'Image clipboard item';
        img.loading = 'lazy';

        if (item.thumbDataUrl && item.thumbDataUrl.startsWith('data:')) {
          // Already loaded thumbnail
          img.src = item.thumbDataUrl;
        } else if (item.thumbPath) {
          // Lazy load thumbnail
          img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDMyMCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTQwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Q0E0QUYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Mb2FkaW5nLi4uPC90ZXh0Pgo8L3N2Zz4=';
          img.dataset.thumbPath = item.thumbPath;

          // Intersection Observer for lazy loading
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                loadThumbnail(img);
                observer.unobserve(img);
              }
            });
          }, { rootMargin: '50px' });

          observer.observe(img);
        }

        itemDiv.innerHTML = `
          ${img.outerHTML}
          <div class="clipboard-time">${dims ? dims + ' ‚Ä¢ ' : ''}${timeAgo(item.timestamp)}</div>
        `;
      } else {
        const safeText = (item.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const dataAttr = (item.text || '').replace(/"/g, '&quot;');
        itemDiv.setAttribute('data-type', 'text');
        itemDiv.setAttribute('data-text', dataAttr);
        itemDiv.innerHTML = `
          <div class="clipboard-text">${safeText}</div>
          <div class="clipboard-time">${timeAgo(item.timestamp)}</div>
        `;
      }

      return itemDiv;
    }

    // Lazy load thumbnail function
    async function loadThumbnail(img) {
      const thumbPath = img.dataset.thumbPath;
      if (!thumbPath) return;

      try {
        const dataUrl = await ipcRenderer.invoke('load-thumbnail', thumbPath);
        if (dataUrl) {
          img.src = dataUrl;
        }
      } catch (error) {
        console.warn('[renderer] Failed to load thumbnail:', error);
        // Fallback to placeholder
        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDMyMCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTQwIiBmaWxsPSIjRkZFRkVFIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5Q0E0QUYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBpbWFnZTwvdGV4dD4KPC9zdmc+';
      }
    }

    // Optimized event handling with event delegation for virtual scrolling
    const listEl = document.getElementById('clipboard-list');
    let clickTimer = null;
    const clickDelayMs = 220; // delay to distinguish double-click

    function handleCopy(itemEl) {
      const type = itemEl.dataset.type;
      if (type === 'image') {
        const id = itemEl.dataset.id;
        ipcRenderer.invoke('copy-item', { type: 'image', id });
      } else {
        const txt = itemEl.dataset.text;
        ipcRenderer.invoke('copy-item', { type: 'text', text: txt });
      }
    }

    function handlePaste(itemEl) {
      const type = itemEl.dataset.type;
      if (type === 'image') {
        const id = itemEl.dataset.id;
        ipcRenderer.invoke('paste-item', { type: 'image', id });
      } else {
        const txt = itemEl.dataset.text;
        ipcRenderer.invoke('paste-item', { type: 'text', text: txt });
      }
    }

    // Use event delegation for virtual scrolling - listen on virtual-items container
    function setupEventDelegation() {
      const virtualItems = document.querySelector('.virtual-items');

      if (virtualItems) {
        // Remove existing listeners to avoid duplicates
        virtualItems.removeEventListener('click', handleItemClick);
        virtualItems.removeEventListener('dblclick', handleItemDblClick);

        // Add new listeners
        virtualItems.addEventListener('click', handleItemClick, { passive: true });
        virtualItems.addEventListener('dblclick', handleItemDblClick, { passive: true });
      }
    }

    function handleItemClick(e) {
      const itemEl = e.target.closest('.clipboard-item');
      if (!itemEl) return;

      // Prevent multiple rapid clicks
      if (clickTimer) return;

      clickTimer = setTimeout(() => {
        if (settings && settings.singleClickAction === 'paste') {
          handlePaste(itemEl);
        } else if (settings && settings.singleClickAction === 'copy') {
          handleCopy(itemEl);
        }
        clickTimer = null;
      }, clickDelayMs);
    }

    function handleItemDblClick(e) {
      const itemEl = e.target.closest('.clipboard-item');
      if (!itemEl) return;
      if (clickTimer) {
        clearTimeout(clickTimer);
        clickTimer = null;
      }
      handlePaste(itemEl);
    }

    // Setup event delegation when virtual scrolling is initialized
    function setupVirtualScroll() {
      const list = document.getElementById('clipboard-list');
      const virtualList = list.querySelector('.virtual-list');
      const spacer = list.querySelector('.virtual-spacer');

      // Set spacer height to represent total content
      spacer.style.height = virtualScrollState.totalHeight + 'px';

      // Debounced scroll handler for better performance
      let scrollTimeout = null;
      const debouncedScroll = () => {
        if (scrollTimeout) return;
        scrollTimeout = setTimeout(() => {
          virtualScrollState.scrollTop = list.scrollTop;
          updateVisibleItems();
          scrollTimeout = null;
        }, 16); // ~60fps
      };

      // Handle scroll events with debouncing
      list.addEventListener('scroll', debouncedScroll, { passive: true });

      // Setup event delegation for the virtual scrolling
      setupEventDelegation();

      // Initial setup
      virtualScrollState.containerHeight = list.clientHeight;
      updateVisibleItems();
    }

    // Search with debouncing for smooth performance - optimized for virtual scrolling
    const searchEl = document.getElementById('search');
    let searchTimeout = null;
    let filteredItems = []; // Cache filtered results

    function applySearch() {
      const q = (searchEl.value || '').toLowerCase().trim();

      if (!q) {
        filteredItems = allItems;
        renderClipboard(allItems);
        return;
      }

      // Optimized filtering with early returns
      filteredItems = allItems.filter(it => {
        if (it.type === 'text') {
          return (it.text || '').toLowerCase().includes(q);
        }
        // For images, search in dimensions
        const dims = `${it.width || ''}x${it.height || ''}`;
        return dims.includes(q);
      });

      renderClipboard(filteredItems);
    }

    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applySearch, 150); // 150ms debounce
    }

    searchEl.addEventListener('input', debouncedSearch, { passive: true });
    // Also handle immediate search on Enter for better UX
    searchEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout);
        applySearch();
      }
    }, { passive: true });

    // Clear history
    async function clearHistory() {
      await ipcRenderer.invoke('clear-history');
    }

    // Show currently effective hotkey
    async function setPlatformHotkey() {
      const hotkey = await ipcRenderer.invoke('get-hotkey');
      document.getElementById('hotkey-display').textContent = hotkey || 'Ctrl+Shift+V';
    }

    // Listen for clipboard updates - optimized for virtual scrolling
    ipcRenderer.on('clipboard-updated', (event, items) => {
      allItems = items || [];
      filteredItems = allItems; // Reset filtered items on update
      applySearch();
    });

    // Reset UI on overlay open: clear search and close settings
    ipcRenderer.on('reset-ui', () => {
      const searchEl = document.getElementById('search');
      if (searchEl.value) {
        searchEl.value = '';
        filteredItems = allItems; // Reset filtered items
      }
      document.getElementById('settings-modal').style.display = 'none';
      document.body.classList.remove('modal-open');

      // Reset virtual scroll state
      virtualScrollState.scrollTop = 0;
      virtualScrollState.startIndex = 0;
      virtualScrollState.endIndex = 0;

      renderClipboard(filteredItems);

      // Focus search input for immediate typing
      setTimeout(() => {
        searchEl.focus();
        // Ensure the input is selected for immediate typing
        searchEl.select();
      }, 200);
    });

    // Initialize
    setPlatformHotkey();
    // Load settings
    async function loadSettings() {
      settings = await ipcRenderer.invoke('get-settings');
      const platform = await ipcRenderer.invoke('get-platform');
      const dataLocation = await ipcRenderer.invoke('get-data-location');
      
      document.getElementById('set-max-history').value = settings.maxHistory;
      document.getElementById('set-thumb-width').value = settings.thumbWidth;
      document.getElementById('set-single-click').value = settings.singleClickAction || 'copy';
      document.getElementById('set-remember-pos').checked = !!settings.rememberPosition;
      
      // Set platform-specific default hotkey
      const defaultHotkey = platform === 'darwin' ? 'Cmd+Shift+V' : 'Ctrl+Shift+V';
      document.getElementById('default-hotkey').textContent = defaultHotkey;
      
      // Show current hotkey or default
      const currentHotkey = await ipcRenderer.invoke('get-hotkey');
      document.getElementById('set-hotkey').value = currentHotkey;
      document.getElementById('set-hotkey').placeholder = `Click to set (default: ${defaultHotkey})`;
      
      // Show data storage location
      document.getElementById('data-location').textContent = dataLocation;
    }
    loadSettings();

    // Hotkey capture functionality
    let isCapturingHotkey = false;
    const hotkeyInput = document.getElementById('set-hotkey');
    const resetHotkeyBtn = document.getElementById('reset-hotkey');
    
    hotkeyInput.addEventListener('click', () => {
      if (isCapturingHotkey) return;
      isCapturingHotkey = true;
      hotkeyInput.value = 'Press keys...';
      hotkeyInput.style.background = '#2a4a2a';
    });
    
    hotkeyInput.addEventListener('keydown', (e) => {
      if (!isCapturingHotkey) return;
      e.preventDefault();
      
      const keys = [];
      if (e.ctrlKey || e.metaKey) keys.push(e.metaKey ? 'Cmd' : 'Ctrl');
      if (e.altKey) keys.push('Alt');
      if (e.shiftKey) keys.push('Shift');
      
      // Only allow valid keys for Electron globalShortcut
      const validKeys = {
        'Enter': 'Return',
        ' ': 'Space',
        'ArrowUp': 'Up',
        'ArrowDown': 'Down',
        'ArrowLeft': 'Left',
        'ArrowRight': 'Right'
      };
      
      if (e.key && !['Control', 'Meta', 'Alt', 'Shift'].includes(e.key)) {
        let keyName = e.key;
        
        // Map special keys
        if (validKeys[e.key]) {
          keyName = validKeys[e.key];
        } else if (e.key.length === 1) {
          // Only allow single character keys (letters, numbers, symbols)
          keyName = e.key.toUpperCase();
        } else {
          // Skip invalid keys
          hotkeyInput.value = 'Invalid key combination';
          setTimeout(() => {
            hotkeyInput.value = 'Press keys...';
          }, 1000);
          return;
        }
        
        keys.push(keyName);
        
        const hotkey = keys.join('+');
        hotkeyInput.value = hotkey;
        hotkeyInput.style.background = '#111';
        isCapturingHotkey = false;
      }
    });
    
    resetHotkeyBtn.addEventListener('click', async () => {
      const platform = await ipcRenderer.invoke('get-platform');
      const defaultHotkey = platform === 'darwin' ? 'Cmd+Shift+V' : 'Ctrl+Shift+V';
      hotkeyInput.value = defaultHotkey;
      hotkeyInput.style.background = '#111';
      isCapturingHotkey = false;
    });

    // Settings modal controls
    window.openSettings = function() {
      const modal = document.getElementById('settings-modal');
      modal.style.display = 'flex';
      modal.scrollTop = 0; // ensure top is visible even when search scrolled the list
      document.body.classList.add('modal-open');
    }
    window.closeSettings = function() {
      document.getElementById('settings-modal').style.display = 'none';
      document.body.classList.remove('modal-open');
    }
    window.saveSettings = async function() {
      const partial = {
        maxHistory: Number(document.getElementById('set-max-history').value),
        thumbWidth: Number(document.getElementById('set-thumb-width').value),
        singleClickAction: document.getElementById('set-single-click').value,
        rememberPosition: document.getElementById('set-remember-pos').checked,
        hotkey: (document.getElementById('set-hotkey').value || '').trim() || null
      };
      settings = await ipcRenderer.invoke('update-settings', partial);
      const hotkey = await ipcRenderer.invoke('get-hotkey');
      document.getElementById('hotkey-display').textContent = hotkey || 'Ctrl+Shift+V';
      closeSettings();
    }
  </script>
</body>
</html>